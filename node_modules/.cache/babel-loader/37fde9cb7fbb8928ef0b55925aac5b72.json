{"ast":null,"code":"var _jsxFileName = \"/Users/mac/Documents/GitHub/deepfake-demo/src/page/demo-scroll.js\",\n  _s = $RefreshSig$();\nimport studio from '@theatre/studio';\nimport { val, getProject } from '@theatre/core';\nimport { useState, useEffect, useRef } from 'react';\nimport styled from 'styled-components';\nimport Stage from '../components/stage';\nimport Dimmer from '../components/dimmer-with-message';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst ScrollSizer = styled.div`\n  position: relative;\n  width: 100vw;\n  min-width: 100vw;\n  max-width: 100vw;\n  min-height: 100vh;\n  background: #ffffff;\n`;\n_c = ScrollSizer;\nconst StickyBox = styled.div`\n  width: 100%;\n  height: 100vh;\n  position: sticky;\n  top: 0;\n  left: 0;\n`;\n_c2 = StickyBox;\nconst defaultScrollScale = 1500;\nexport default function DemoScroll() {\n  _s();\n  studio.initialize();\n  studio.ui.hide();\n  const project = getProject('Project', {});\n  const sheet = project.sheet('Scene', 'default');\n  project.ready.then(() => sheet.sequence.pause());\n\n  // --------------------------\n\n  const objJson = localStorage.getItem('theatre-data'); // get objectJSON in local-storage\n  const objData = objJson ? JSON.parse(objJson) : [];\n\n  // --------------------------\n\n  // TODO: 增加條件，減少 event-listener 偵測時間\n\n  const [scrollPosition, setScrollPosition] = useState(0);\n  const sequenceLength = val(sheet.sequence.pointer.length);\n  const stageRef = useRef(null);\n  useEffect(() => {\n    const handleScroll = () => {\n      const stage = stageRef.current;\n      const sizer = stage.closest('.theatre-scroll-sizer');\n      const stageRect = stage.getBoundingClientRect();\n      const sizerRect = sizer.getBoundingClientRect();\n      const distance = stageRect.top - sizerRect.top;\n      setScrollPosition(distance);\n    };\n    window.addEventListener('scroll', handleScroll);\n    return () => {\n      window.removeEventListener('scroll', handleScroll);\n    };\n  }, []);\n  useEffect(() => {\n    const newPosition = scrollPosition / (sequenceLength * defaultScrollScale) * sequenceLength;\n    sheet.sequence.position = newPosition;\n  }, [scrollPosition]);\n\n  // ----------------------------\n\n  const [hasMediaError, setHasMediaError] = useState(false); // image & background && video onError\n  const [loadedMedias, setLoadedMedias] = useState(0); // image & background && video onload\n  const [isLoading, setIsLoading] = useState(true);\n  const totalMedias = objData.filter(data => data.type === 'IMAGE' || data.type === 'BACKGROUND' || data.type === 'VIDEO').length;\n  console.log('loadedMedias', loadedMedias);\n  console.log('totalMedias', totalMedias);\n  console.log('isLoading', isLoading);\n\n  // useEffect(() => {\n  //   if (loadedMedias === totalMedias) {\n  //     setIsLoading(false);\n  //   }\n  // }, [loadedMedias, totalMedias]);\n\n  useEffect(() => {\n    const handleResize = () => {\n      // 重新判斷是否所有媒體都載入完成\n      if (loadedMedias >= totalMedias) {\n        setIsLoading(false);\n      }\n    };\n    window.addEventListener('resize', handleResize);\n\n    // 記得在 useEffect 結束時移除事件監聽\n    return () => {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, [loadedMedias, totalMedias]);\n  const sizerHeight = hasMediaError || isLoading ? '100vh' : `${sequenceLength * defaultScrollScale}px`;\n  return /*#__PURE__*/_jsxDEV(ScrollSizer, {\n    className: \"theatre-scroll-sizer\",\n    style: {\n      height: sizerHeight\n    },\n    children: /*#__PURE__*/_jsxDEV(StickyBox, {\n      ref: stageRef,\n      children: [/*#__PURE__*/_jsxDEV(Dimmer, {\n        show: isLoading && !hasMediaError,\n        message: '載入中',\n        shining: true\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 123,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Dimmer, {\n        show: hasMediaError,\n        message: '載入失敗。請檢查您的網路連線，並重新整理瀏覽器。'\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 128,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Stage, {\n        objData: objData,\n        sheet: sheet,\n        stageWidth: window.innerWidth,\n        draggable: false,\n        setHasMediaError: setHasMediaError,\n        setLoadedMedias: setLoadedMedias\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 132,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 122,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 118,\n    columnNumber: 5\n  }, this);\n}\n_s(DemoScroll, \"BZPypNBc5svEjc0fi+rhFAiXBe4=\");\n_c3 = DemoScroll;\nvar _c, _c2, _c3;\n$RefreshReg$(_c, \"ScrollSizer\");\n$RefreshReg$(_c2, \"StickyBox\");\n$RefreshReg$(_c3, \"DemoScroll\");","map":{"version":3,"names":["studio","val","getProject","useState","useEffect","useRef","styled","Stage","Dimmer","jsxDEV","_jsxDEV","ScrollSizer","div","_c","StickyBox","_c2","defaultScrollScale","DemoScroll","_s","initialize","ui","hide","project","sheet","ready","then","sequence","pause","objJson","localStorage","getItem","objData","JSON","parse","scrollPosition","setScrollPosition","sequenceLength","pointer","length","stageRef","handleScroll","stage","current","sizer","closest","stageRect","getBoundingClientRect","sizerRect","distance","top","window","addEventListener","removeEventListener","newPosition","position","hasMediaError","setHasMediaError","loadedMedias","setLoadedMedias","isLoading","setIsLoading","totalMedias","filter","data","type","console","log","handleResize","sizerHeight","className","style","height","children","ref","show","message","shining","fileName","_jsxFileName","lineNumber","columnNumber","stageWidth","innerWidth","draggable","_c3","$RefreshReg$"],"sources":["/Users/mac/Documents/GitHub/deepfake-demo/src/page/demo-scroll.js"],"sourcesContent":["import studio from '@theatre/studio';\nimport { val, getProject } from '@theatre/core';\nimport { useState, useEffect, useRef } from 'react';\nimport styled from 'styled-components';\nimport Stage from '../components/stage';\nimport Dimmer from '../components/dimmer-with-message';\n\nconst ScrollSizer = styled.div`\n  position: relative;\n  width: 100vw;\n  min-width: 100vw;\n  max-width: 100vw;\n  min-height: 100vh;\n  background: #ffffff;\n`;\n\nconst StickyBox = styled.div`\n  width: 100%;\n  height: 100vh;\n  position: sticky;\n  top: 0;\n  left: 0;\n`;\n\nconst defaultScrollScale = 1500;\n\nexport default function DemoScroll() {\n  studio.initialize();\n  studio.ui.hide();\n  const project = getProject('Project', {});\n  const sheet = project.sheet('Scene', 'default');\n  project.ready.then(() => sheet.sequence.pause());\n\n  // --------------------------\n\n  const objJson = localStorage.getItem('theatre-data'); // get objectJSON in local-storage\n  const objData = objJson ? JSON.parse(objJson) : [];\n\n  // --------------------------\n\n  // TODO: 增加條件，減少 event-listener 偵測時間\n\n  const [scrollPosition, setScrollPosition] = useState(0);\n\n  const sequenceLength = val(sheet.sequence.pointer.length);\n  const stageRef = useRef(null);\n\n  useEffect(() => {\n    const handleScroll = () => {\n      const stage = stageRef.current;\n      const sizer = stage.closest('.theatre-scroll-sizer');\n\n      const stageRect = stage.getBoundingClientRect();\n      const sizerRect = sizer.getBoundingClientRect();\n\n      const distance = stageRect.top - sizerRect.top;\n      setScrollPosition(distance);\n    };\n\n    window.addEventListener('scroll', handleScroll);\n\n    return () => {\n      window.removeEventListener('scroll', handleScroll);\n    };\n  }, []);\n\n  useEffect(() => {\n    const newPosition =\n      (scrollPosition / (sequenceLength * defaultScrollScale)) * sequenceLength;\n    sheet.sequence.position = newPosition;\n  }, [scrollPosition]);\n\n  // ----------------------------\n\n  const [hasMediaError, setHasMediaError] = useState(false); // image & background && video onError\n  const [loadedMedias, setLoadedMedias] = useState(0); // image & background && video onload\n  const [isLoading, setIsLoading] = useState(true);\n\n  const totalMedias = objData.filter(\n    (data) =>\n      data.type === 'IMAGE' ||\n      data.type === 'BACKGROUND' ||\n      data.type === 'VIDEO'\n  ).length;\n\n  console.log('loadedMedias', loadedMedias);\n  console.log('totalMedias', totalMedias);\n  console.log('isLoading', isLoading);\n\n  // useEffect(() => {\n  //   if (loadedMedias === totalMedias) {\n  //     setIsLoading(false);\n  //   }\n  // }, [loadedMedias, totalMedias]);\n\n  useEffect(() => {\n    const handleResize = () => {\n      // 重新判斷是否所有媒體都載入完成\n      if (loadedMedias >= totalMedias) {\n        setIsLoading(false);\n      }\n    };\n\n    window.addEventListener('resize', handleResize);\n\n    // 記得在 useEffect 結束時移除事件監聽\n    return () => {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, [loadedMedias, totalMedias]);\n\n  const sizerHeight =\n    hasMediaError || isLoading\n      ? '100vh'\n      : `${sequenceLength * defaultScrollScale}px`;\n\n  return (\n    <ScrollSizer\n      className='theatre-scroll-sizer'\n      style={{ height: sizerHeight }}\n    >\n      <StickyBox ref={stageRef}>\n        <Dimmer\n          show={isLoading && !hasMediaError}\n          message={'載入中'}\n          shining={true}\n        />\n        <Dimmer\n          show={hasMediaError}\n          message={'載入失敗。請檢查您的網路連線，並重新整理瀏覽器。'}\n        />\n        <Stage\n          objData={objData}\n          sheet={sheet}\n          stageWidth={window.innerWidth}\n          draggable={false}\n          setHasMediaError={setHasMediaError}\n          setLoadedMedias={setLoadedMedias}\n        />\n      </StickyBox>\n    </ScrollSizer>\n  );\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}